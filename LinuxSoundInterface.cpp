#include "LinuxSoundInterface.h"

#include <iostream>
#include <cmath>

//==================================================================================================== 
//==================================================================================================== 
//==================================================================================================== 
LinuxSoundInterface::LinuxSoundInterface():
	m_interfaceName("default"),
	m_mixerName("Master")
{
	this->_init();
}

//==================================================================================================== 
//==================================================================================================== 
//==================================================================================================== 
LinuxSoundInterface::LinuxSoundInterface(const std::string p_sInterfaceName, const std::string p_sMixerName):
	m_interfaceName(p_sInterfaceName),
	m_mixerName(p_sMixerName)
{
	this->_init();
}

//==================================================================================================== 
//==================================================================================================== 
//==================================================================================================== 
LinuxSoundInterface::~LinuxSoundInterface()
{
	this->_end();
}

//==================================================================================================== 
//==================================================================================================== 
//==================================================================================================== 
void LinuxSoundInterface::_init()
{
	snd_mixer_open(&m_handle, 0);
    snd_mixer_attach(m_handle, m_interfaceName.c_str());
    snd_mixer_selem_register(m_handle, NULL, NULL);
    snd_mixer_load(m_handle);

    snd_mixer_selem_id_alloca(&m_sid);
    snd_mixer_selem_id_set_index(m_sid, 0);
    snd_mixer_selem_id_set_name(m_sid, m_mixerName.c_str());

    m_elem = snd_mixer_find_selem(m_handle, m_sid);
    snd_mixer_selem_get_playback_volume_range(m_elem, &m_volumeMin, &m_volumeMax);

	//retrieve current volume
	snd_mixer_selem_get_playback_volume (m_elem, SND_MIXER_SCHN_FRONT_LEFT, &m_volumeCurrent);
	m_volumeCurrent = std::ceil((float)m_volumeCurrent / (float)m_volumeMax * 100.f);
}

//==================================================================================================== 
//==================================================================================================== 
//==================================================================================================== 
void  LinuxSoundInterface::_end()
{
	snd_mixer_close(m_handle);
	free(m_handle);
	free(m_sid);
}

//==================================================================================================== 
//==================================================================================================== 
//==================================================================================================== 
long LinuxSoundInterface::getVolumeMin() const
{
	return m_volumeMin;
}

//==================================================================================================== 
//==================================================================================================== 
//==================================================================================================== 
long LinuxSoundInterface::getVolumeMax() const
{
	return m_volumeMax;
}

//==================================================================================================== 
//==================================================================================================== 
//==================================================================================================== 
long LinuxSoundInterface::getVolumeCurrent() const
{
	return m_volumeCurrent;
}

//==================================================================================================== 
//==================================================================================================== 
//==================================================================================================== 
void LinuxSoundInterface::volumeSetValue(std::uint8_t p_volume)
{
	m_volumeCurrent = p_volume;
	snd_mixer_selem_set_playback_volume_all(m_elem, p_volume * m_volumeMax / 100);
}

//==================================================================================================== 
//==================================================================================================== 
//==================================================================================================== 
void LinuxSoundInterface::toggleSound(bool toggle)
{
	std::uint8_t volumeApplied = (toggle) ? m_volumeCurrent : 0;
	snd_mixer_selem_set_playback_volume_all(m_elem, volumeApplied * m_volumeMax / 100);
}

